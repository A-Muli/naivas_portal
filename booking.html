<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Activation | Naivas Portal</title>

<style>
  body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:#f4f6f8;}
  .container{background:#fff;padding:2rem;border-radius:12px;max-width:900px;margin:2rem auto;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  label{font-weight:600;margin-bottom:.4rem;display:block;}
  input,select{width:100%;padding:.7rem;border:1px solid #ccc;border-radius:6px;}
  button{padding:.9rem;border:none;border-radius:6px;cursor:pointer;font-weight:bold;}
  .submit-btn{background:#f58220;color:#fff;width:100%;margin-top:1.5rem;}
  .ba-section{background:#fafafa;padding:1rem;border-radius:8px;margin-top:1rem;border:1px solid #ddd;}
  .ba-entry{background:#fff;border:1px solid #ddd;border-radius:8px;padding:1rem;margin-bottom:1rem;position:relative;}
  .remove-ba{position:absolute;top:10px;right:10px;background:#e74c3c;color:#fff;padding:.3rem .6rem;border-radius:4px;}
  .add-ba{background:#4bb300;color:#fff;padding:.6rem;border-radius:6px;margin-top:.5rem;}
  table{width:100%;border-collapse:collapse;margin-top:2rem;}
  th,td{padding:.8rem;border:1px solid #ddd;font-size:.9rem;}
  th{background:#f58220;color:#fff;text-align:left;}
  .cancel-btn{background:#c0392b;color:#fff;padding:.4rem .7rem;border-radius:5px;cursor:pointer;}
  .profile{font-weight:bold;color:#f58220;margin-bottom:.5rem;}
</style>
</head>
<body>

<div id="navbar-placeholder"></div>
<script>
// ✅ Load Navbar
fetch("navbar.html")
  .then(res => res.text())
  .then(html => {
    document.getElementById("navbar-placeholder").innerHTML = html;

    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    const nameEl = document.getElementById("profileName");
    const picEl = document.getElementById("profilePic");

    if (user) {
      nameEl.textContent = user.SupplierName || "User";
      if (user.profilePic) picEl.src = user.profilePic;
    }

    const dropdown = document.querySelector(".profile-dropdown");
    const trigger = document.querySelector(".profile-trigger");
    const logoutLink = document.getElementById("logoutLink");

    trigger.addEventListener("click", () => dropdown.classList.toggle("active"));
    window.addEventListener("click", e => { if(!dropdown.contains(e.target)) dropdown.classList.remove("active"); });

    logoutLink.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = "signin.html";
    });
  });
</script>


<div class="container">
<h2 style="text-align:center;color:#f58220;">Book an Activation</h2>
<div class="profile" id="userWelcome"></div>
<form id="bookingForm">

<div class="form-group">
<label>Product Category</label>
<select id="productCategory" required>
<option value="">Select Category</option>
<option value="Grocery 1">Grocery 1</option>
<option value="Fresh">Fresh</option>
<option value="Fresh Produce">Fresh Produce</option>
<option value="Home & Hygiene">Home & Hygiene</option>
<option value="Non Food">Non Food</option>
<option value="Impulse & Liquor">Impulse & Liquor</option>
<option value="Food Pantry">Food Pantry</option>
</select>
</div>

<div class="form-group">
<label>Product Type</label>
<select id="productType" required><option value="">Select Product Type</option></select>
</div>

<div class="form-group">
<label>Product Name</label>
<input type="text" id="productName" required/>
</div>

<div class="form-group">
<label>Store</label>
<select id="storeName" required><option value="">Select Store</option></select>
</div>

<div class="form-group">
<label>Activation Date</label>
<input type="date" id="activationDate" required/>
</div>

<div class="ba-section">
<h3>Brand Ambassadors</h3>
<div id="baContainer"></div>
<button type="button" id="addBA" class="add-ba">+ Add Brand Ambassador</button>
</div>

<button type="submit" class="submit-btn">Submit Booking</button>
</form>

<h3 style="margin-top:2rem;color:#f58220;">Your Upcoming Bookings</h3>
<table id="bookingsTable">
<thead>
<tr><th>Store</th><th>Date</th><th>Category</th><th>Type</th><th>BAs</th><th>Status</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
// ✅ Show user welcome
let user=JSON.parse(localStorage.getItem("loggedInUser"));
if(!user)location.href="signin.html";
document.getElementById("userWelcome").innerText = `Welcome, ${user.SupplierName}`;

// ✅ Category mapping
const productMapping={"Grocery 1":["Milk","Flour","Fats & Oils","Sugar","Rice","Pasta + Noodles","Cereals & Pulses"],"Fresh":["Chilled & Frozen Products","Fresh Meat, Poultry & Eggs","Naivas Bakery","Meat Products","Outsourced Bakery","Naivas Deli + Coffee Shop"],"Fresh Produce":["Fruits + Veg"],"Home & Hygiene":["Laundry","Personal Care","Beauty","Paper + Plastics","Health Care and Nutrition","Baby Products","Home Cleaning","Household Essentials","Pet Care","Aircare + Home Fragrance"],"Non Food":["Electronics","Textiles","Stationery","Kitchen and Dining","Leisure & DIY"],"Impulse & Liquor":["Snacks","Confectionery","Spirits","Beer","Wine","Smoking Accessories"],"Food Pantry":["Cold Beverage","Food Additives","Breakfast","Hot Beverage","Canned & Ethnic Foods"]};

document.getElementById("productCategory").onchange=function(){let dd=document.getElementById("productType");dd.innerHTML='<option value="">Select Product Type</option>';(productMapping[this.value]||[]).forEach(t=>dd.innerHTML+=`<option>${t}</option>`);};

// ✅ Load stores
async function loadStores(){ 
  const r=await fetch("backend/getstores.php");
  const s=await r.json();let dd=document.getElementById("storeName");s.forEach(x=>dd.innerHTML+=`<option value="${x.storeName}">${x.storeName} (${x.region})</option>`);}document.addEventListener("DOMContentLoaded",loadStores);

// ✅ BA management
let baCount=0;
document.getElementById("addBA").onclick=()=>{if(baCount>=3)return alert("Max 3 BAs");baCount++;let d=document.createElement("div");d.className="ba-entry";d.innerHTML=`<h4>BA ${baCount}</h4><button type="button" class="remove-ba">X</button><label>Name</label><input class="ba-name" required><label>ID Number</label><input class="ba-id" required><label>Phone</label><input class="ba-phone" required>`;d.querySelector(".remove-ba").onclick=()=>{d.remove();baCount--;};document.getElementById("baContainer").appendChild(d);};

// ✅ Capacity check
async function checkCapacity(store,date,count){const r=await fetch("backend/storecapacity.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({store,date})});const d=await r.json();return d.current + count <= d.max;}

// ✅ Submit booking
document.getElementById("bookingForm").onsubmit=async e=>{e.preventDefault();let store=document.getElementById("storeName").value;let date=document.getElementById("activationDate").value;let BAs=[...document.querySelectorAll(".ba-entry")].map(x=>({name:x.querySelector(".ba-name").value,idNumber:x.querySelector(".ba-id").value,phoneNumber:x.querySelector(".ba-phone").value}));if(!BAs.length)return alert("Add at least one BA");if(!(await checkCapacity(store,date,BAs.length)))return alert("Store full that day");let body={supplierEmail:user.email,storeName:store,productCategory:productCategory.value,productType:productType.value,productName:productName.value,activationDate:date,brandAmbassadors:BAs};let r=await fetch("backend/savebooking.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});let j=await r.json();alert(j.message);if(j.success)loadBookings();};

// ✅ Load user bookings
async function loadBookings(){const r=await fetch(`backend/getbooking.php?email=${user.email}`);const data=await r.json();let tbody=document.querySelector("#bookingsTable tbody");tbody.innerHTML="";data.forEach(b=>{tbody.innerHTML+=`<tr><td>${b.storeName}</td><td>${b.activationDate}</td><td>${b.productCategory}</td><td>${b.productType}</td><td>${b.no_of_BAs}</td><td>${b.status}</td><td>${b.status=='pending'?`<button class='cancel-btn' onclick="cancelBooking(${b.id})">Cancel</button>`:''}</td></tr>`;});}

// ✅ Cancel booking
async function cancelBooking(id){if(!confirm("Cancel booking?"))return;await fetch("backend/bookingaction.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,action:"cancel"})});alert("Booking cancelled");loadBookings();}

loadBookings();
</script>
</body>
</html>