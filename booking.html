<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Activation | Naivas Portal</title>

<style>
/* --- STYLES --- */
body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f4f6f8;
    color: #333;
}

header {
    background: #000;
    padding: 0.8rem 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.logo img {
    height: 45px;
}

.container {
    background: #fff;
    padding: 2rem 2.5rem;
    border-radius: 12px;
    width: 95%;
    max-width: 800px;
    margin: 2.5rem auto;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

h2 {
    text-align: center;
    color: #f58220;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1.2rem;
}

label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: #333;
}

input, select {
    width: 100%;
    padding: 0.7rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s;
    box-sizing: border-box;
}

input:focus, select:focus {
    outline: none;
    border-color: #f58220;
}

button {
    padding: 0.9rem;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.submit-btn {
    background: #f58220;
    color: white;
    width: 100%;
    margin-top: 1.5rem;
    transition: background 0.3s;
}

.submit-btn:hover {
    background: #4bb300;
}

.ba-section {
    background: #f9fafb;
    padding: 1rem 1.2rem;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    margin-top: 1.5rem;
}

.ba-section h3 { color: #000; margin-bottom: 1rem; }
.ba-entry { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; position: relative; }
.ba-entry h4 { color: #f58220; margin-bottom: 0.5rem; }
.remove-ba { position: absolute; top: 10px; right: 10px; background: #e74c3c; border: none; color: white; padding: 0.3rem 0.6rem; cursor: pointer; border-radius: 4px; font-size: 0.9rem; }
.remove-ba:hover { background: #c0392b; }
.add-ba { background: #4bb300; border: none; padding: 0.6rem 1.2rem; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 1rem; transition: background 0.3s; }
.add-ba:hover { background: #2d7700; }

/* Custom styles for the new multi-select dropdown */
.store-dropdown-container {
    border: 1px solid #ccc;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    margin-top: 5px;
    display: none;
    background: white;
    z-index: 1001;
    position: absolute;
    width: 100%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.store-dropdown-container input[type="text"] {
    width: calc(100% - 10px);
    padding: 8px;
    margin: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

#storeChecklist label {
    display: flex;
    align-items: center;
    font-weight: normal;
    cursor: pointer;
    padding: 5px;
    margin: 0;
    transition: background 0.1s;
}
#storeChecklist label:hover {
    background: #f0f0f0;
}
#storeChecklist input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
    height: auto;
    padding: 0;
}
</style>
</head>

<body>

<div id="navbar-placeholder"></div>

<script>
fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
        document.getElementById("navbar-placeholder").innerHTML = html;

        const user = JSON.parse(localStorage.getItem("loggedInUser"));
        const nameEl = document.getElementById("profileName");
        const picEl = document.getElementById("profilePic");

        if (user) {
            nameEl.textContent = user.SupplierName || user.name || "User";
            if (user.profilePic) picEl.src = user.profilePic;
        }

        const logoutLink = document.getElementById("logoutLink");
        if(logoutLink) {
             logoutLink.addEventListener("click", (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = "signin.html";
            });
        }
       
    });
</script>


<div class="container">
    <h2>Book an Activation</h2>
    
    <form id="bookingForm">
        
        <div class="form-group">
            <label>Product Category</label>
            <select id="productCategory" required>
                <option value="">Select Category</option>
                <option>Grocery 1</option>
                <option>Fresh</option>
                <option>Fresh Produce</option>
                <option>Home & Hygiene</option>
                <option>Non Food</option>
                <option>Impulse & Liquor</option>
                <option>Food Pantry</option>
            </select>
        </div>

        <div class="form-group">
            <label>Product Type</label>
            <select id="productType" required>
                <option value="">Select Product Type</option>
            </select>
        </div>

        <div class="form-group">
            <label>Product Name</label>
            <input type="text" id="productName" required placeholder="Enter product name">
        </div>

        <div class="form-group" style="position: relative; z-index: 10;">
            <label>Store(s) - Select all stores for this activation</label>
            
            <input type="text" id="storeSelectInput" placeholder="Click to select stores..." readonly required style="cursor: pointer;">
            <input type="hidden" id="selectedStoresHidden" required>

            <div id="storeDropdownContainer" class="store-dropdown-container">
                <input type="text" id="storeSearch" placeholder="Search stores...">
                <div id="storeChecklist" style="padding: 0 10px 10px 10px;">
                    </div>
            </div>
        </div>
        <div class="form-group">
            <label>Activation Date</label>
            <input type="date" id="activationDate" required>
        </div>

        <div class="ba-section">
            <h3>Brand Ambassadors</h3>
            <p style="font-size: 0.9rem; color:#555;margin-top:-5px;">Assign BAs to the selected stores.</p>
            <div id="baContainer"></div>
            <button type="button" class="add-ba" id="addBA">+ Add Brand Ambassador</button>
        </div>

        <button type="submit" class="submit-btn">Submit Booking</button>
    </form>
</div>

<script>
// Product mapping (unchanged)
const productMapping = {
    "Grocery 1": ["Milk", "Flour", "Fats & Oils", "Sugar", "Rice", "Pasta + Noodles", "Cereals & Pulses"],
    "Fresh": ["Chilled & Frozen Products","Fresh Meat, Poultry & Eggs","Naivas Bakery","Meat Products","Outsourced Bakery","Naivas Deli + Coffee Shop"],
    "Fresh Produce": ["Fruits + Veg"],
    "Home & Hygiene": ["Laundry","Personal Care","Beauty","Paper + Plastics","Health Care and Nutrition","Baby Products","Home Cleaning","Household Essentials","Pet Care","Aircare + Home Fragrance"],
    "Non Food": ["Electronics","Textiles","Stationery","Kitchen and Dining","Leisure & DIY"],
    "Impulse & Liquor": ["Snacks","Confectionery","Spirits","Beer","Wine","Smoking Accessories"],
    "Food Pantry": ["Cold Beverage","Food Additives","Breakfast","Hot Beverage","Canned & Ethnic Foods"]
};

// Handle Product Type filtering (unchanged)
document.getElementById("productCategory").addEventListener("change", function() {
    const typeDropdown = document.getElementById("productType");
    typeDropdown.innerHTML = '<option value="">Select Product Type</option>';
    const list = productMapping[this.value];
    if (list) list.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        typeDropdown.appendChild(opt);
    });
});

// Cache all stores fetched from the backend
let allAvailableStores = [];

/* ------------------------- STORE MULTI-SELECT LOGIC ------------------------- */

// Function to get the currently selected stores (from checkboxes)
function getSelectedStores() {
    const selected = [];
    document.querySelectorAll('#storeChecklist input[type="checkbox"]:checked').forEach(checkbox => {
        selected.push({
            name: checkbox.value,
            text: checkbox.dataset.text
        });
    });
    return selected;
}

// Function to populate the checklist div with options
function populateStoreChecklist(storesToDisplay) {
    const checklist = document.getElementById("storeChecklist");
    checklist.innerHTML = ''; 
    
    if (storesToDisplay.length === 0) {
        checklist.innerHTML = '<p style="padding: 5px; color: #777;">No stores match your search.</p>';
        return;
    }

    // Get current selections to maintain state across search filters
    const selectedStoresNames = getSelectedStores().map(s => s.name); 

    storesToDisplay.forEach(store => {
        const isChecked = selectedStoresNames.includes(store.name) ? 'checked' : ''; 

        const storeDiv = document.createElement('div');
        storeDiv.innerHTML = `
            <label>
                <input type="checkbox" value="${store.name}" data-text="${store.text}" ${isChecked}>
                ${store.text}
            </label>
        `;
        checklist.appendChild(storeDiv);
    });
}

// Function to update the input field and trigger BA warning/clear
function updateSelectedStores() {
    const currentBACount = document.querySelectorAll(".ba-entry").length;
    const selected = getSelectedStores();
    const input = document.getElementById("storeSelectInput");
    const hidden = document.getElementById("selectedStoresHidden");
    
    if (currentBACount > 0) {
        // Warning: If stores change, clear BAs.
        const confirmed = confirm("WARNING: Changing the selected store(s) will clear all currently added Brand Ambassadors to ensure re-assignment is correct. Continue?");
        if (confirmed) {
            baContainer.innerHTML = "";
            baCount = 0;
        } else {
            // If the user cancels the clear, we need to revert the checkbox state that just changed.
            // This is complex, so for simplicity in pure JS, the user should be aware that 
            // cancelling the clear still means their BA assignments are potentially incorrect 
            // based on the new store selection. We will proceed with the clear for safety.
            baContainer.innerHTML = "";
            baCount = 0;
        }
    }

    if (selected.length === 0) {
        input.value = '';
        hidden.value = ''; 
    } else {
        input.value = `${selected.length} store(s) selected: ${selected.map(s => s.name).join(', ')}`;
        hidden.value = selected.map(s => s.name).join(',');
    }
}

// Function to handle opening, closing, and updating the store selection
function setupStoreDropdownHandlers() {
    const input = document.getElementById("storeSelectInput");
    const container = document.getElementById("storeDropdownContainer");
    const search = document.getElementById("storeSearch");
    const checklist = document.getElementById("storeChecklist");

    // Toggle dropdown visibility
    input.addEventListener('click', (e) => {
        e.stopPropagation(); 
        container.style.display = container.style.display === 'block' ? 'none' : 'block';
        if (container.style.display === 'block') {
             search.focus();
             // Ensure the checklist is populated correctly when opening
             populateStoreChecklist(allAvailableStores.filter(store => 
                store.text.toLowerCase().includes(search.value.toLowerCase())
             ));
        }
    });

    // Close dropdown if user clicks outside
    document.addEventListener('click', (e) => {
        if (!container.contains(e.target) && e.target !== input) {
            container.style.display = 'none';
        }
    });

    // Handle search filtering
    search.addEventListener('keyup', () => {
        const searchTerm = search.value.toLowerCase();
        const filteredStores = allAvailableStores.filter(store => 
            store.text.toLowerCase().includes(searchTerm)
        );
        populateStoreChecklist(filteredStores); 
    });

    // Handle checkbox change (uses event delegation on the checklist container)
    checklist.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            updateSelectedStores();
        }
    });
}

// Load all stores into the new checklist interface
async function loadStores() {
    try {
        const res = await fetch("http://localhost/naivas_portal/backend/getstores.php");
        const response = await res.json();
        
        if (!response.success || !Array.isArray(response.data)) throw "Invalid response from getstores.php";

        allAvailableStores = response.data.map(store => ({
            name: store.storeName,
            text: `${store.storeName} (${store.region})`
        }));
        
        setupStoreDropdownHandlers();
        populateStoreChecklist(allAvailableStores); // Initial load of all stores

    } catch (err) {
        console.error("Error loading stores:", err);
        alert("Error loading stores. Please check the backend/getstores.php endpoint.");
    }
}

document.addEventListener("DOMContentLoaded", loadStores);

/* ------------------------- BRAND AMBASSADOR LOGIC ------------------------- */

const baContainer = document.getElementById("baContainer");
let baCount = 0;

document.getElementById("addBA").addEventListener("click", () => {
    if (baCount >= 9) return alert("Max 9 BAs");

    const stores = getSelectedStores(); 
    if (!stores.length) {
        return alert("Please select one or more stores for this activation before adding Brand Ambassadors.");
    }
    
    baCount++;
    const div = document.createElement("div");
    div.className = "ba-entry";
    
    // Create the store dropdown options using the currently selected stores
    const storeOptions = stores.map(s => `<option value="${s.name}">${s.text}</option>`).join("");

    div.innerHTML = `
        <h4>Brand Ambassador ${baCount}</h4>
        <button type="button" class="remove-ba">Remove</button>
        <label>Name</label><input type="text" class="ba-name" required>
        <label>ID Number</label><input type="text" class="ba-id" required>
        <label>Phone Number</label><input type="text" class="ba-phone" required>
        
        <div class="form-group" style="margin-top:10px;">
            <label>Assigned Store</label>
            <select class="ba-store" required>
                <option value="">Select Store for BA</option>
                ${storeOptions}
            </select>
        </div>
    `;
    
    const removeButton = div.querySelector(".remove-ba");
    removeButton.onclick = () => { 
        div.remove(); 
        baCount--; 
    };
    
    baContainer.appendChild(div);
});

/* ------------------------- DATE RESTRICTIONS (unchanged) ------------------------- */

const activationDateInput = document.getElementById("activationDate");
activationDateInput.min = new Date().toISOString().split("T")[0];

activationDateInput.addEventListener("input", function () {
    const day = new Date(this.value).getDay();
    if (![0, 5, 6].includes(day)) {
        alert("Activations are only allowed on Friday (5), Saturday (6), or Sunday (0).");
        this.value = "";
    }
});

/* ------------------------- FORM SUBMISSION ------------------------- */

document.getElementById("bookingForm").addEventListener("submit", async e => {
    e.preventDefault();
    
    const selectedStoresData = getSelectedStores(); 
    const selectedStores = selectedStoresData.map(s => s.name);
    
    if (!selectedStores.length) {
         document.getElementById("storeSelectInput").focus();
         return alert("Please select at least 1 store for the activation.");
    }
    
    const user = JSON.parse(localStorage.getItem("loggedInUser")) || {};
    
    const bas = [...document.querySelectorAll(".ba-entry")].map(x => ({
        name: x.querySelector(".ba-name").value,
        idNumber: x.querySelector(".ba-id").value,
        phoneNumber: x.querySelector(".ba-phone").value,
        storeAssigned: x.querySelector(".ba-store").value 
    }));

    if (!bas.length) return alert("Add at least 1 Brand Ambassador");
    
    const unassignedBA = bas.find(ba => !ba.storeAssigned);
    if (unassignedBA) {
        return alert("Please ensure every Brand Ambassador is assigned to a specific store from the selected list.");
    }

    const data = {
        supplierEmail: user.email,
        stores: selectedStores, 
        productCategory: productCategory.value,
        productType: productType.value,
        productName: productName.value,
        activationDate: activationDate.value,
        brandAmbassadors: bas
    };
    
    if (!confirm(`Confirm submission of this activation request for ${selectedStores.length} store(s)?`)) return;

    try {
        const res = await fetch("http://localhost/naivas_portal/backend/savebooking.php", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        alert(result.message);
        if (result.success) {
            document.getElementById("bookingForm").reset();
            baContainer.innerHTML = "";
            baCount = 0;
            updateSelectedStores(); // Clears the store input display
        }
    } catch (e) {
        console.error(e);
        alert("Error submitting booking. Please check network connection or server endpoint.");
    }
});
</script>

</body>
</html>