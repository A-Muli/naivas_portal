<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Activation</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f9;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
  }
  .container {
    background: #fff;
    padding: 2rem;
    border-radius: 10px;
    width: 90%;
    max-width: 700px;
    margin-top: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  }
  h2 {
    text-align: center;
    color: #333;
    margin-bottom: 1rem;
  }
  .form-group { margin-bottom: 1rem; }
  label {
    display: block;
    font-weight: bold;
    margin-bottom: 0.3rem;
    color: #444;
  }
  input, select {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
  }
  button {
    padding: 0.8rem;
    background: #4bb300;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 1rem;
    width: 100%;
    font-size: 1rem;
  }
  button:hover { background: #3b8e00; }
  .ba-section {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
  }
  .ba-entry {
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    background: #fff;
    position: relative;
  }
  .remove-ba {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #e74c3c;
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
    border-radius: 4px;
  }
  .remove-ba:hover { background: #c0392b; }
  .add-ba {
    background: #007bff;
    border: none;
    padding: 0.5rem 1rem;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 1rem;
    display: block;
  }
  .add-ba:hover { background: #0056b3; }
</style>
</head>

<body>
<div class="container">
  <h2>Book Activation</h2>
  <form id="bookingForm">
    <div class="form-group">
      <label for="productCategory">Product Category</label>
      <select id="productCategory" required>
        <option value="">Select Category</option>
        <option value="Grocery 1">Grocery 1</option>
        <option value="Fresh">Fresh</option>
        <option value="Fresh Produce">Fresh Produce</option>
        <option value="Home & Hygiene">Home & Hygiene</option>
        <option value="Non Food">Non Food</option>
        <option value="Impulse & Liquor">Impulse & Liquor</option>
        <option value="Food Pantry">Food Pantry</option>
      </select>
    </div>

    <div class="form-group">
      <label for="productType">Product Type</label>
      <select id="productType" required>
        <option value="">Select Product Type</option>
      </select>
    </div>

    <div class="form-group">
      <label for="productName">Product Name</label>
      <input type="text" id="productName" required placeholder="Enter product name">
    </div>

    <div class="form-group">
      <label for="storeName">Store</label>
      <select id="storeName" required>
        <option value="">Select Store</option>
      </select>
    </div>

    <div class="form-group">
      <label for="activationDate">Activation Date</label>
      <input type="date" id="activationDate" required>
    </div>

    <div class="ba-section">
      <h3>Brand Ambassadors</h3>
      <div id="baContainer"></div>
      <button type="button" class="add-ba" id="addBA">+ Add Brand Ambassador</button>
    </div>

    <button type="submit">Submit Booking</button>
  </form>
</div>

<script>
// ----------------------------
// Product Category Mapping
// ----------------------------
const productMapping = {
  "Grocery 1": ["Milk", "Flour", "Fats & Oils", "Sugar", "Rice", "Pasta + Noodles", "Cereals & Pulses"],
  "Fresh": ["Chilled & Frozen Products", "Fresh Meat, Poultry & Eggs", "Naivas Bakery", "Meat Products", "Outsourced Bakery", "Naivas Deli + Coffee Shop"],
  "Fresh Produce": ["Fruits + Veg"],
  "Home & Hygiene": ["Laundry", "Personal Care", "Beauty", "Paper + Plastics", "Health Care and Nutrition", "Baby Products", "Home Cleaning", "Household Essentials", "Pet Care", "Aircare + Home Fragrance"],
  "Non Food": ["Electronics", "Textiles", "Stationery", "Kitchen and Dining", "Leisure & DIY"],
  "Impulse & Liquor": ["Snacks", "Confectionery", "Spirits", "Beer", "Wine", "Smoking Accessories"],
  "Food Pantry": ["Cold Beverage", "Food Additives", "Breakfast", "Hot Beverage", "Canned & Ethnic Foods"]
};

// Populate Product Type based on Category
document.getElementById("productCategory").addEventListener("change", function() {
  const typeDropdown = document.getElementById("productType");
  typeDropdown.innerHTML = '<option value="">Select Product Type</option>';
  const selectedCategory = this.value;
  if (productMapping[selectedCategory]) {
    productMapping[selectedCategory].forEach(type => {
      const option = document.createElement("option");
      option.value = type;
      option.textContent = type;
      typeDropdown.appendChild(option);
    });
  }
});

// ----------------------------
// Activation Date Validation (Only Fri, Sat, Sun)
// ----------------------------
const activationDateInput = document.getElementById("activationDate");
activationDateInput.addEventListener("change", function() {
  const selectedDate = new Date(this.value);
  const day = selectedDate.getDay(); // Sunday=0, Monday=1,... Saturday=6
  if (day !== 5 && day !== 6 && day !== 0) {
    alert("Please select a date that falls on Friday, Saturday, or Sunday.");
    this.value = "";
  }
});

// ----------------------------
// Load Stores from Backend
// ----------------------------
async function loadStores() {
  try {
    const res = await fetch("http://localhost/naivas_portal/backend/getstores.php");
    const stores = await res.json();
    const dropdown = document.getElementById("storeName");
    stores.forEach(store => {
      const option = document.createElement("option");
      option.value = store.storeName;
      option.textContent = `${store.storeName} (${store.region})`;
      dropdown.appendChild(option);
    });
  } catch (err) {
    console.error("Error loading stores:", err);
    alert("Could not load store list.");
  }
}
document.addEventListener("DOMContentLoaded", loadStores);

// ----------------------------
// Brand Ambassadors Section
// ----------------------------
const baContainer = document.getElementById("baContainer");
const addBAButton = document.getElementById("addBA");
let baCount = 0;

addBAButton.addEventListener("click", () => {
  if (baCount >= 3) { alert("You can add up to 3 Brand Ambassadors only."); return; }
  baCount++;

  const baDiv = document.createElement("div");
  baDiv.classList.add("ba-entry");
  baDiv.innerHTML = `
    <h4>Brand Ambassador ${baCount} <button type="button" class="remove-ba">Remove</button></h4>
    <label>Name</label><input type="text" class="ba-name" required placeholder="Enter name">
    <label>ID Number</label><input type="text" class="ba-id" required placeholder="Enter ID number">
    <label>Phone Number</label><input type="text" class="ba-phone" required placeholder="Enter phone number">
  `;

  baDiv.querySelector(".remove-ba").addEventListener("click", () => {
    baDiv.remove();
    baCount--;
  });
  baContainer.appendChild(baDiv);
});

// ----------------------------
// Submit Booking Form
// ----------------------------
document.getElementById("bookingForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const supplier = JSON.parse(localStorage.getItem("loggedInUser")) || { email: "test@example.com" };
  const brandAmbassadors = [...document.querySelectorAll(".ba-entry")].map(entry => ({
    name: entry.querySelector(".ba-name").value.trim(),
    idNumber: entry.querySelector(".ba-id").value.trim(),
    phoneNumber: entry.querySelector(".ba-phone").value.trim()
  }));

  const data = {
    supplierEmail: supplier.email,
    storeName: document.getElementById("storeName").value,
    productCategory: document.getElementById("productCategory").value,
    productType: document.getElementById("productType").value,
    productName: document.getElementById("productName").value.trim(),
    activationDate: document.getElementById("activationDate").value,
    brandAmbassadors
  };

  try {
    const res = await fetch("http://localhost/naivas_portal/backend/savebooking.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const text = await res.text();
    let result;
    try { result = JSON.parse(text); } catch (err) {
      console.error("Invalid JSON response:", text);
      alert("Server returned invalid response.");
      return;
    }

    alert(result.message);
    if (result.success) {
      document.getElementById("bookingForm").reset();
      baContainer.innerHTML = "";
      baCount = 0;
    }
  } catch (err) {
    console.error(err);
    alert("Error connecting to server. Please try again.");
  }
});
</script>
</body>
</html>
