<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Book Activation | Naivas Portal</title>

<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f4f6f8;
    color: #333;
  }

  header {
    background: #000;
    padding: 0.8rem 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo img {
    height: 45px;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 2rem;
  }

  nav ul {
    list-style: none;
    display: flex;
    gap: 1.5rem;
    margin: 0;
    padding: 0;
  }

  nav ul li a {
    text-decoration: none;
    color: white;
    font-weight: bold;
    font-size: 1rem;
    transition: color 0.3s;
  }

  nav ul li a:hover {
    color: #f58220;
  }

  .container {
    background: #fff;
    padding: 2rem 2.5rem;
    border-radius: 12px;
    width: 95%;
    max-width: 800px;
    margin: 2.5rem auto;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  h2 {
    text-align: center;
    color: #f58220;
    margin-bottom: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.2rem;
  }

  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: #333;
  }

  input, select {
    width: 100%;
    padding: 0.7rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s;
  }

  input:focus, select:focus {
    outline: none;
    border-color: #f58220;
  }

  button {
    padding: 0.9rem;
    font-size: 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  .submit-btn {
    background: #f58220;
    color: white;
    width: 100%;
    margin-top: 1.5rem;
    transition: background 0.3s;
  }

  .submit-btn:hover {
    background: #4bb300;
  }

  .ba-section {
    background: #f9fafb;
    padding: 1rem 1.2rem;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    margin-top: 1.5rem;
  }

  .ba-section h3 {
    color: #000;
    margin-bottom: 1rem;
  }

  .ba-entry {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
  }

  .ba-entry h4 {
    color: #f58220;
    margin-bottom: 0.5rem;
  }

  .remove-ba {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #e74c3c;
    border: none;
    color: white;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .remove-ba:hover {
    background: #c0392b;
  }

  .add-ba {
    background: #4bb300;
    border: none;
    padding: 0.6rem 1.2rem;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 1rem;
    transition: background 0.3s;
  }

  .add-ba:hover {
    background: #2d7700;
  }
</style>
</head>

<body>

<div id="navbar-placeholder"></div>

<script>
fetch("navbar.html")
  .then(res => res.text())
  .then(html => {
    document.getElementById("navbar-placeholder").innerHTML = html;

    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    const nameEl = document.getElementById("profileName");
    const picEl = document.getElementById("profilePic");

    if (user) {
      nameEl.textContent = user.SupplierName || user.name || "User";
      if (user.profilePic) picEl.src = user.profilePic;
    }

    const dropdown = document.querySelector(".profile-dropdown");
    const trigger = document.querySelector(".profile-trigger");
    const logoutLink = document.getElementById("logoutLink");

    trigger.addEventListener("click", () => dropdown.classList.toggle("active"));
    window.addEventListener("click", e => {
      if (!dropdown.contains(e.target)) dropdown.classList.remove("active");
    });

    logoutLink.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = "signin.html";
    });
  });
</script>

<div class="container">
  <h2>Book an Activation</h2>
  
  <form id="bookingForm">
    
    <div class="form-group">
      <label>Product Category</label>
      <select id="productCategory" required>
        <option value="">Select Category</option>
        <option>Grocery 1</option>
        <option>Fresh</option>
        <option>Fresh Produce</option>
        <option>Home & Hygiene</option>
        <option>Non Food</option>
        <option>Impulse & Liquor</option>
        <option>Food Pantry</option>
      </select>
    </div>

    <div class="form-group">
      <label>Product Type</label>
      <select id="productType" required>
        <option value="">Select Product Type</option>
      </select>
    </div>

    <div class="form-group">
      <label>Product Name</label>
      <input type="text" id="productName" required placeholder="Enter product name">
    </div>

    <div class="form-group">
      <label>Store</label>
      <select id="storeName" required>
        <option value="">Select Store</option>
      </select>
    </div>

    <div class="form-group">
      <label>Activation Date</label>
      <input type="date" id="activationDate" required>
    </div>

    <div class="ba-section">
      <h3>Brand Ambassadors</h3>
      <p style="font-size: 0.9rem; color:#555;margin-top:-5px;">Add at least one BA.</p>
      <div id="baContainer"></div>
      <button type="button" class="add-ba" id="addBA">+ Add Brand Ambassador</button>
    </div>

    <button type="submit" class="submit-btn">Submit Booking</button>
  </form>
</div>

<script>
// Product mapping
const productMapping = {
  "Grocery 1": ["Milk", "Flour", "Fats & Oils", "Sugar", "Rice", "Pasta + Noodles", "Cereals & Pulses"],
  "Fresh": ["Chilled & Frozen Products","Fresh Meat, Poultry & Eggs","Naivas Bakery","Meat Products","Outsourced Bakery","Naivas Deli + Coffee Shop"],
  "Fresh Produce": ["Fruits + Veg"],
  "Home & Hygiene": ["Laundry","Personal Care","Beauty","Paper + Plastics","Health Care and Nutrition","Baby Products","Home Cleaning","Household Essentials","Pet Care","Aircare + Home Fragrance"],
  "Non Food": ["Electronics","Textiles","Stationery","Kitchen and Dining","Leisure & DIY"],
  "Impulse & Liquor": ["Snacks","Confectionery","Spirits","Beer","Wine","Smoking Accessories"],
  "Food Pantry": ["Cold Beverage","Food Additives","Breakfast","Hot Beverage","Canned & Ethnic Foods"]
};

document.getElementById("productCategory").addEventListener("change", function() {
  const typeDropdown = document.getElementById("productType");
  typeDropdown.innerHTML = '<option value="">Select Product Type</option>';
  const list = productMapping[this.value];
  if (list) list.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    typeDropdown.appendChild(opt);
  });
});

// Load stores
async function loadStores() {
  try {
    const res = await fetch("http://localhost/naivas_portal/backend/getstores.php");
    const response = await res.json();
    if (!response.success || !Array.isArray(response.data)) throw "Invalid";

    const dropdown = document.getElementById("storeName");
    response.data.forEach(store => {
      const option = document.createElement("option");
      option.value = store.storeName;
      option.textContent = `${store.storeName} (${store.region})`;
      dropdown.appendChild(option);
    });
  } catch (err) {
    console.error(err);
    alert("Error loading stores.");
  }
}
document.addEventListener("DOMContentLoaded", loadStores);

// BA logic
const baContainer = document.getElementById("baContainer");
let baCount = 0;
document.getElementById("addBA").addEventListener("click", () => {
  if (baCount >= 3) return alert("Max 3 BAs");
  baCount++;
  const div = document.createElement("div");
  div.className = "ba-entry";
  div.innerHTML = `
    <h4>Brand Ambassador ${baCount}</h4>
    <button type="button" class="remove-ba">Remove</button>
    <label>Name</label><input type="text" class="ba-name" required>
    <label>ID Number</label><input type="text" class="ba-id" required>
    <label>Phone Number</label><input type="text" class="ba-phone" required>
  `;
  div.querySelector(".remove-ba").onclick = () => { div.remove(); baCount--; };
  baContainer.appendChild(div);
});

// Disable weekdays except Fri(5), Sat(6), Sun(0)
const activationDateInput = document.getElementById("activationDate");

// Set min date = today
activationDateInput.min = new Date().toISOString().split("T")[0];

// Disable weekdays in calendar
activationDateInput.addEventListener("input", function () {
  const day = new Date(this.value).getDay();
  if (![0, 5, 6].includes(day)) {
    alert("Activations are only allowed on Friday, Saturday, or Sunday.");
    this.value = "";
  }
});

// Submit booking
document.getElementById("bookingForm").addEventListener("submit", async e => {
  e.preventDefault();
  const user = JSON.parse(localStorage.getItem("loggedInUser")) || {};
  const bas = [...document.querySelectorAll(".ba-entry")].map(x => ({
    name: x.querySelector(".ba-name").value,
    idNumber: x.querySelector(".ba-id").value,
    phoneNumber: x.querySelector(".ba-phone").value
  }));

  if (!bas.length) return alert("Add at least 1 Brand Ambassador");

  const data = {
    supplierEmail: user.email,
    storeName: storeName.value,
    productCategory: productCategory.value,
    productType: productType.value,
    productName: productName.value,
    activationDate: activationDate.value,
    brandAmbassadors: bas
  };

  try {
    const res = await fetch("http://localhost/naivas_portal/backend/savebooking.php", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    const result = await res.json();
    alert(result.message);
    if (result.success) {
      document.getElementById("bookingForm").reset();
      baContainer.innerHTML = "";
      baCount = 0;
    }
  } catch (e) {
    alert("Error submitting booking");
  }
});
</script>

</body>
</html>
