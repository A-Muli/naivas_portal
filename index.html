<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naivas Portal - Dashboard</title>
<style>
/* ===== GLOBAL STYLES ===== */
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f4f6f8;
  color: #333;
}

/* ===== SECTIONS ===== */
.container { max-width:1100px;margin:2rem auto;padding:0 1rem; }
.welcome { background:linear-gradient(to right,#f58220,#4bb300);color:white;padding:2rem;border-radius:12px; }
.welcome h2{margin:0;font-size:1.8rem;}

.booking-section { margin-top:2rem;background:white;border-radius:12px;padding:2rem;text-align:center; }
.book-btn { background:#f58220;color:white;border:none;border-radius:6px;padding:1rem 2rem;font-size:1.1rem;font-weight:bold;cursor:pointer; }
.book-btn:hover{background:#4bb300;}

.activations { margin-top:2rem; }
.cards { display:flex;flex-wrap:wrap;gap:1.5rem;margin-top:1rem; }
.card {
  flex:1;min-width:280px;background:white;border-radius:12px;padding:1.5rem;
  box-shadow:0 3px 6px rgba(0,0,0,0.08);text-align:center;cursor:pointer;
}
.card:hover{transform:scale(1.03);}
.approved { border-left:6px solid #4bb300; }
.pending { border-left:6px solid #f58220; }
.rejected { border-left:6px solid #e74c3c; }

/* BA Section */
.ba-section { margin-top:3rem;background:white;border-radius:12px;padding:2rem; }
table { width:100%;border-collapse:collapse;margin-top:1rem; }
th,td { border:1px solid #ddd;padding:0.8rem;text-align:center; }
th { background:#4bb300;color:white; }

/* ===== MODAL ===== */
.modal {
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);justify-content:center;align-items:center;
}
.modal-content {
  background:white;width:90%;max-width:900px;border-radius:10px;padding:2rem;
}
.modal-header {
  display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #f58220;
}
.close-btn { background:none;border:none;font-size:1.5rem;cursor:pointer;color:#f58220; }

.cancel-btn {
  background:red;color:white;border:none;padding:6px 10px;border-radius:6px;
  cursor:pointer;font-size:0.9rem;font-weight:bold;
}
.cancel-btn:hover { background:darkred; }

/* ==== NAVBAR PLACEHOLDER ==== */
#navbar-placeholder { width:100%; }
</style>
</head>

<body>

<!-- NAVBAR -->
<div id="navbar-placeholder"></div>

<script>
// âœ… Load Navbar
fetch("navbar.html")
  .then(res => res.text())
  .then(html => {
    document.getElementById("navbar-placeholder").innerHTML = html;

    const user = JSON.parse(localStorage.getItem("loggedInUser"));
    const nameEl = document.getElementById("profileName");
    const picEl = document.getElementById("profilePic");

    if (user) {
      nameEl.textContent = user.SupplierName || "User";
      if (user.profilePic) picEl.src = user.profilePic;
    }

    const dropdown = document.querySelector(".profile-dropdown");
    const trigger = document.querySelector(".profile-trigger");
    const logoutLink = document.getElementById("logoutLink");

    trigger.addEventListener("click", () => dropdown.classList.toggle("active"));
    window.addEventListener("click", e => { if(!dropdown.contains(e.target)) dropdown.classList.remove("active"); });

    logoutLink.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.clear();
      window.location.href = "signin.html";
    });
  });
</script>


<div class="container">

<section class="welcome">
  <h2>Welcome back, <span id="userName">User</span> ðŸ‘‹</h2>
  <p><strong>Company:</strong> <span id="CompanyName"> </span></p>
  <p><strong>Email:</strong> <span id="email"> </span></p>
</section>


<section class="booking-section">
  <h3>Ready to book your next activation?</h3>
  <button class="book-btn" onclick="location.href='booking.html'">Book Activation</button>
</section>

<section class="activations">
  <h3>My Activations Overview</h3>
  <div class="cards">
    <div class="card approved" id="approvedCard"><h4>Approved</h4><p id="approvedCount">0</p></div>
    <div class="card pending" id="pendingCard"><h4>Pending</h4><p id="pendingCount">0</p></div>
    <div class="card rejected" id="rejectedCard"><h4>Rejected</h4><p id="rejectedCount">0</p></div>
  </div>
</section>

<section class="ba-section">
  <h3>My Brand Ambassadors</h3>
  <table>
    <thead><tr><th>Name</th><th>ID</th><th>Phone</th><th>Status</th></tr></thead>
    <tbody id="baTable"><tr><td colspan="4">Loading...</td></tr></tbody>
  </table>
</section>

</div>


<!-- MODAL -->
<div class="modal" id="activationModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Activation Details</h3>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>

    <table>
      <thead>
        <tr><th>Store</th><th>Category</th><th>Type</th><th>Product</th><th>Date</th><th>Action</th></tr>
      </thead>
      <tbody id="activationDetails"></tbody>
    </table>
  </div>
</div>

<script>
const user = JSON.parse(localStorage.getItem("loggedInUser"));
if(!user) location.href="signin.html";

document.getElementById("userName").textContent = user.SupplierName;
document.getElementById("CompanyName").textContent = user.CompanyName || "-";
document.getElementById("email").textContent = user.email;

let activations = [];

// âœ… Load Activations
async function loadActivations(){
  let r = await fetch("http://localhost/naivas_portal/backend/get_activations.php", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ email:user.email })
  });

  let res = await r.json();

  if (!res.success) {
    console.error("Failed to load activations:", res);
    return;
  }

  activations = res.data;

  document.getElementById("approvedCount").textContent =
    activations.filter(a=>a.status==="Approved").length;

  document.getElementById("pendingCount").textContent =
    activations.filter(a=>a.status==="Pending").length;

  document.getElementById("rejectedCount").textContent =
    activations.filter(a=>a.status==="Rejected").length;
}



// âœ… Modal Open
function openModal(status){
  const modal=document.getElementById("activationModal");
  const tbody=document.getElementById("activationDetails");
  tbody.innerHTML="";
  const filtered=activations.filter(a=>a.status===status);

  filtered.forEach(a=>{
    tbody.innerHTML += `
      <tr>
        <td>${a.storeName}</td>
        <td>${a.productCategory}</td>
        <td>${a.productType}</td>
        <td>${a.productName}</td>
        <td>${a.activationDate}</td>
        <td>
          ${status==="pending"
            ? `<button class="cancel-btn" onclick="cancelActivation('${a.ba_id}')">Cancel</button>` 
            : `-`
          }
        </td>
      </tr>`;
  });

  modal.style.display="flex";
}

document.getElementById("closeModal").onclick=()=>document.getElementById("activationModal").style.display="none";
window.onclick=e=>{ if(e.target.id==="activationModal") document.getElementById("activationModal").style.display="none"; };

document.getElementById("approvedCard").onclick = () => openModal("Approved");
document.getElementById("pendingCard").onclick = () => openModal("Pending");
document.getElementById("rejectedCard").onclick = () => openModal("Rejected");


// âœ… Cancel Activation
async function cancelActivation(id){
  if(!confirm("Are you sure you want to cancel this activation?")) return;

  let r = await fetch("http://localhost/naivas_portal/backend/bookingaction.php",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ booking_id:id }) 
  });

  let res = await r.json();
  alert(res.message);

  loadActivations();
  document.getElementById("activationModal").style.display="none";
}


// âœ… Load Brand Ambassadors
async function loadBAs() {
  let r = await fetch("http://localhost/naivas_portal/backend/getBAs.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: user.email })
  });

  let res = await r.json();
  let table = document.getElementById("baTable");

  if (!res.success || res.data.length === 0) {
    table.innerHTML = `<tr><td colspan="4">No Brand Ambassadors found</td></tr>`;
    return;
  }

  table.innerHTML = "";
  res.data.forEach(ba => {
    table.innerHTML += `
      <tr>
        <td>${ba.name}</td>
        <td>${ba.idNumber}</td>
        <td>${ba.phoneNumber}</td>
        <td>${ba.status}</td>
      </tr>`;
  });
}


// âœ… Load everything
document.addEventListener("DOMContentLoaded", () => {
  loadActivations();
  loadBAs();
});
</script>

</body>
</html>
